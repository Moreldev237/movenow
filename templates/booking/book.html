
{% extends 'base.html' %}

{% block title %}Commander - MoveNow{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Commander un trajet</h1>
            <p class="text-gray-500 mt-1">Indiquez votre point de depart et votre destination</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Map Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden relative">
                    <!-- Loading overlay -->
                    <div id="map-loading" class="absolute inset-0 bg-gray-100 z-10 flex items-center justify-center">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-600">Chargement de la carte...</p>
                            <p class="text-sm text-gray-400 mt-2">Verifiez votre connexion internet</p>
                        </div>
                    </div>
                    <!-- Map error message -->
                    <div id="map-error" class="hidden absolute inset-0 bg-gray-100 z-20 flex items-center justify-center">
                        <div class="text-center p-6">
                            <i class="fas fa-exclamation-triangle text-4xl text-orange-500 mb-4"></i>
                            <p class="text-gray-700 font-medium">Impossible de charger la carte</p>
                            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                                Rafraichir
                            </button>
                        </div>
                    </div>
                    <div id="booking-map" class="h-[500px]"></div>
                    
                    <!-- Map controls -->
                    <div class="absolute bottom-4 left-4 z-10 flex flex-col gap-2">
                        <button onclick="focusOnPickup()" class="bg-white p-2 rounded-lg shadow-md hover:bg-gray-50 transition" title="Recenter sur le depart">
                            <i class="fas fa-map-marker-alt text-green-500"></i>
                        </button>
                        <button onclick="focusOnDropoff()" class="bg-white p-2 rounded-lg shadow-md hover:bg-gray-50 transition" title="Recenter sur la destination">
                            <i class="fas fa-map-marker-alt text-red-500"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Instructions card -->
                <div class="mt-4 bg-white rounded-2xl shadow-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-info-circle text-orange-500 mr-2"></i>
                        Comment utiliser
                    </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>1. Entrez votre depart ou cliquez adresse de sur la carte</li>
                        <li>2. Entrez votre destination ou cliquez sur la carte</li>
                        <li>3. Choisissez votre type de vehicule</li>
                        <li>4. Consultez le prix estime</li>
                        <li>5. Recherchez un chauffeur</li>
                    </ul>
                </div>
            </div>
            
            <!-- Booking Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Details du trajet</h2>
                    
                    <form method="POST" id="booking-form" class="space-y-4">
                        {% csrf_token %}
                        
                        <!-- Vehicle Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type de vehicule</label>
                            <div class="grid grid-cols-2 gap-3">
                                {% for vehicle_type in vehicle_types %}
                                <label class="cursor-pointer">
                                    <input type="radio" name="vehicle_type" value="{{ vehicle_type.id }}" class="sr-only peer" data-base-price="{{ vehicle_type.base_price }}" data-price-per-km="{{ vehicle_type.price_per_km }}" {% if forloop.first %}checked{% endif %}>
                                    <div class="p-3 border rounded-lg hover:border-orange-500 transition peer-checked:border-orange-500 peer-checked:bg-orange-50">
                                        <div class="flex items-center">
                                            {% if vehicle_type.name == 'moto' %}
                                                <i class="fas fa-motorcycle text-orange-500 mr-2"></i>
                                            {% elif vehicle_type.name == 'voiture' %}
                                                <i class="fas fa-car text-orange-500 mr-2"></i>
                                            {% elif vehicle_type.name == 'van' %}
                                                <i class="fas fa-shuttle-van text-orange-500 mr-2"></i>
                                            {% elif vehicle_type.name == 'vip' %}
                                                <i class="fas fa-star text-orange-500 mr-2"></i>
                                            {% else %}
                                                <i class="fas fa-car text-orange-500 mr-2"></i>
                                            {% endif %}
                                            <div>
                                                <span class="text-sm font-medium block">{{ vehicle_type.get_name_display }}</span>
                                                <span class="text-xs text-gray-500">{{ vehicle_type.price_per_km }} XAF/km</span>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Pickup Location -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-map-marker-alt text-green-500 mr-1"></i>
                                Point de depart
                            </label>
                            <div class="relative">
                                <input type="text" id="id_pickup_address" name="pickup_address" placeholder="Adresse de depart" class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition" autocomplete="off">
                                <button type="button" onclick="useCurrentLocation()" title="Utiliser ma position actuelle" id="location-btn-pickup" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-orange-500 transition">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </div>
                            <div id="pickup-status" class="hidden mt-1">
                                <span class="text-xs flex items-center" id="pickup-status-text">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Position definie
                                </span>
                            </div>
                            <input type="hidden" id="id_pickup_lat" name="pickup_lat" value="">
                            <input type="hidden" id="id_pickup_lng" name="pickup_lng" value="">
                        </div>
                        
                        <!-- Dropoff Location -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                                Destination
                            </label>
                            <input type="text" id="id_dropoff_address" name="dropoff_address" placeholder="Adresse de destination" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition" autocomplete="off">
                            <div id="dropoff-status" class="hidden mt-1">
                                <span class="text-xs flex items-center" id="dropoff-status-text">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Destination definie
                                </span>
                            </div>
                            <input type="hidden" id="id_dropoff_lat" name="dropoff_lat" value="">
                            <input type="hidden" id="id_dropoff_lng" name="dropoff_lng" value="">
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="flex gap-3 text-sm">
                            <button type="button" onclick="swapLocations()" class="flex items-center text-gray-500 hover:text-orange-500 transition px-3 py-1 rounded-lg hover:bg-gray-100" id="swap-btn">
                                <i class="fas fa-exchange-alt mr-2"></i>
                                Echanger
                            </button>
                            <button type="button" onclick="clearLocations()" class="flex items-center text-gray-500 hover:text-red-500 transition px-3 py-1 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Effacer
                            </button>
                        </div>
                        
                        <!-- Route info -->
                        <div id="route-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-blue-700">
                                    <i class="fas fa-route mr-1"></i>
                                    <span id="route-distance">-- km</span>
                                </span>
                                <span class="text-blue-700">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span id="route-duration">-- min</span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Shared Ride Option -->
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <input type="checkbox" id="is_shared" name="is_shared" class="h-4 w-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                            <label for="is_shared" class="ml-3 text-sm text-gray-700">
                                <i class="fas fa-users text-orange-500 mr-1"></i>
                                <strong>Covoiturage</strong> (-30%)
                            </label>
                        </div>
                        
                        <!-- Estimated Fare -->
                        <div class="bg-gradient-to-r from-orange-50 to-gray-50 rounded-xl p-4 border border-orange-100">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Distance estimee</span>
                                <span class="font-semibold" id="estimated-distance">-- km</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Duree estimee</span>
                                <span class="font-semibold" id="estimated-duration">-- min</span>
                            </div>
                            <hr class="my-3 border-orange-200">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800">Prix estime</span>
                                <span class="text-2xl font-bold text-orange-500" id="estimated-fare">-- XAF</span>
                            </div>
                        </div>
                        
                       
                        
                        <!-- Driver Selection Section (Hidden initially) -->
                        <div id="driver-selection-section" class="hidden">
                            <hr class="my-4 border-gray-200">
                            
                            <!-- Selected Driver Display -->
                            <div id="selected-driver-display" class="hidden mb-4">
                                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-check text-green-500"></i>
                                            </div>
                                            <div>
                                                <p class="font-semibold text-green-800">Chauffeur selectionne</p>
                                                <p class="text-sm text-green-600" id="selected-driver-name">--</p>
                                            </div>
                                        </div>
                                        <button type="button" onclick="clearDriverSelection()" class="text-gray-400 hover:text-red-500">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Available Drivers List -->
                            <div id="drivers-list" class="space-y-3 max-h-64 overflow-y-auto">
                                <!-- Drivers will be loaded here via JavaScript -->
                            </div>
                            
                            <!-- Loading Drivers -->
                            <div id="drivers-loading" class="hidden text-center py-4">
                                <div class="loading-spinner mx-auto mb-2" style="width:24px;height:24px;"></div>
                                <p class="text-sm text-gray-500">Recherche de chauffeurs...</p>
                            </div>
                            
                            <!-- No Drivers Found -->
                            <div id="no-drivers" class="hidden text-center py-4">
                                <i class="fas fa-car text-gray-300 text-3xl mb-2"></i>
                                <p class="text-gray-500">Aucun chauffeur disponible</p>
                                <p class="text-sm text-gray-400">Essayez avec un autre type de vehicule</p>
                            </div>
                        </div>
                        
                        <!-- Payment Method (Hidden until driver selected) -->
                        <div id="payment-section" class="hidden">
                            <hr class="my-4 border-gray-200">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mode de paiement</label>
                                <select name="payment_method" id="payment-method-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
                                    <option value="cash">Especes</option>
                                    <option value="mobile_money">Mobile Money</option>
                                    <option value="orange_money">Orange Money</option>
                                    <option value="card">Carte bancaire</option>
                                </select>
                            </div>
                            
                            <!-- Submit -->
                            <button type="submit" id="submit-btn" class="w-full bg-orange-500 text-white py-4 rounded-xl font-semibold hover:bg-orange-600 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-check mr-2"></i>
                                Confirmer et payer
                            </button>
                        </div>
                        
                        <!-- Initial Submit (Hidden after driver search) -->
                        <button type="button" id="initial-submit-btn" class="w-full bg-orange-500 text-white py-4 rounded-xl font-semibold hover:bg-orange-600 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" onclick="validateAndSearchDrivers()">
                            <i class="fas fa-taxi mr-2"></i>
                            Rechercher un chauffeur
                        </button>
                    </form>
                    
                    <!-- Payment Simulation Modal -->
                    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
                            <!-- Modal Header -->
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-bold text-white">
                                        <i class="fas fa-credit-card mr-2"></i>
                                        Paiement
                                    </h3>
                                    <button type="button" onclick="closePaymentModal()" class="text-white hover:text-gray-200">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Modal Body -->
                            <div class="p-6">
                                <!-- Trip Summary -->
                                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                                    <h4 class="font-semibold text-gray-800 mb-3">Récapitulatif</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Chauffeur</span>
                                            <span class="font-medium" id="modal-driver-name">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Distance</span>
                                            <span class="font-medium" id="modal-distance">-- km</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Durée</span>
                                            <span class="font-medium" id="modal-duration">-- min</span>
                                        </div>
                                        <hr class="my-2">
                                        <div class="flex justify-between text-lg font-bold">
                                            <span>Total à payer</span>
                                            <span class="text-orange-500" id="modal-fare">-- XAF</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payment Method Selection -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mode de paiement</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="cursor-pointer">
                                            <input type="radio" name="modal_payment_method" value="cash" class="sr-only peer" checked>
                                            <div class="p-3 border border-gray-200 rounded-lg peer-checked:border-orange-500 peer-checked:bg-orange-50 transition text-center">
                                                <i class="fas fa-money-bill-wave text-green-500 text-xl mb-1"></i>
                                                <p class="text-xs font-medium">Espèces</p>
                                            </div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="modal_payment_method" value="mobile_money" class="sr-only peer">
                                            <div class="p-3 border border-gray-200 rounded-lg peer-checked:border-orange-500 peer-checked:bg-orange-50 transition text-center">
                                                <i class="fas fa-mobile-alt text-orange-500 text-xl mb-1"></i>
                                                <p class="text-xs font-medium">Mobile Money</p>
                                            </div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="modal_payment_method" value="orange_money" class="sr-only peer">
                                            <div class="p-3 border border-gray-200 rounded-lg peer-checked:border-orange-500 peer-checked:bg-orange-50 transition text-center">
                                                <i class="fab fa-orange text-yellow-500 text-xl mb-1"></i>
                                                <p class="text-xs font-medium">Orange Money</p>
                                            </div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="modal_payment_method" value="card" class="sr-only peer">
                                            <div class="p-3 border border-gray-200 rounded-lg peer-checked:border-orange-500 peer-checked:bg-orange-50 transition text-center">
                                                <i class="far fa-credit-card text-blue-500 text-xl mb-1"></i>
                                                <p class="text-xs font-medium">Carte</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Payment Details (for card/mobile money) -->
                                <div id="modal-payment-details" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
                                    <div id="card-details" class="hidden space-y-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Numéro de carte</label>
                                            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" class="w-full px-3 py-2 border rounded-lg text-sm">
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Expire</label>
                                                <input type="text" id="card-expiry" placeholder="MM/YY" class="w-full px-3 py-2 border rounded-lg text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">CVV</label>
                                                <input type="text" id="card-cvv" placeholder="123" class="w-full px-3 py-2 border rounded-lg text-sm">
                                            </div>
                                        </div>
                                    </div>
                                    <div id="mobile-details" class="hidden">
                                        <p class="text-sm text-gray-600 mb-2">Un code de confirmation sera envoyé à votre numéro.</p>
                                        <input type="text" id="phone-number" placeholder="Votre numéro de téléphone" class="w-full px-3 py-2 border rounded-lg text-sm">
                                    </div>
                                </div>
                                
                                <!-- Loading State -->
                                <div id="payment-loading" class="hidden text-center py-4">
                                    <div class="loading-spinner mx-auto mb-3" style="width:40px;height:40px;"></div>
                                    <p class="text-gray-600">Traitement du paiement...</p>
                                </div>
                                
                                <!-- Error Message -->
                                <div id="payment-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                                    <p class="text-red-600 text-sm"><i class="fas fa-exclamation-circle mr-1"></i> <span id="payment-error-text">Erreur lors du paiement</span></p>
                                </div>
                                
                                <!-- Success Message -->
                                <div id="payment-success" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-center">
                                    <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
                                    <p class="text-green-700 font-semibold">Paiement confirmé!</p>
                                    <p class="text-green-600 text-sm">Création de votre course...</p>
                                </div>
                            </div>
                            
                            <!-- Modal Footer -->
                            <div class="px-6 py-4 bg-gray-50 flex gap-3" id="modal-footer">
                                <button type="button" onclick="closePaymentModal()" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-100 transition">
                                    Annuler
                                </button>
                                <button type="button" onclick="processPayment()" class="flex-1 px-4 py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 transition">
                                    <i class="fas fa-lock mr-2"></i>
                                    Payer
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Safety Info -->
                    <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
                        <div class="flex items-start">
                            <i class="fas fa-shield-alt text-green-500 mt-1 mr-3 text-xl"></i>
                            <div>
                                <p class="font-medium text-green-800">Tous nos chauffeurs sont verifies</p>
                                <p class="text-sm text-green-600">Profil valide, note minimum 4.5/5</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Loading spinner */
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e5e7eb;
        border-top-color: #f97316;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Address inputs */
    #id_pickup_address, #id_dropoff_address {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    #id_pickup_address:focus, #id_dropoff_address:focus {
        border-color: #f97316;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        outline: none;
    }
    
    /* Google Maps */
    #booking-map {
        width: 100%;
        height: 500px;
        background: #f3f4f6;
    }
    
    /* Autocomplete styles */
    .pac-container {
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        font-family: inherit !important;
        z-index: 1000 !important;
    }
    
    .pac-item {
        padding: 10px 12px !important;
        border-top: none !important;
        cursor: pointer;
    }
    
    .pac-item:hover {
        background-color: #fff7ed !important;
    }
    
    .pac-icon {
        display: none !important;
    }
    
    .pac-matched {
        font-weight: 600;
        color: #f97316;
    }
    
    /* Status indicators */
    #pickup-status-text {
        color: #16a34a;
    }
    
    #dropoff-status-text {
        color: #dc2626;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Configuration - Centre de Douala, Cameroun
    const DEFAULT_CENTER = { lat: 4.0333, lng: 9.7167 };
    
    // Variables globales
    let map;
    let pickupMarker, dropoffMarker;
    let directionsService, directionsRenderer;
    let pickupAutocomplete, dropoffAutocomplete;
    let mapLoaded = false;
    
    // Attendre que le DOM soit pret
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM charge, attente de Google Maps API...');
        
        // Verifier si Google Maps est deja charge
        if (typeof google !== 'undefined' && google.maps) {
            console.log('Google Maps deja charge');
            initializeMap();
        } else {
            // Ecouter l'evenement de chargement de l'API
            document.addEventListener('googleMapsLoaded', function() {
                console.log('Google Maps charge via evenement');
                initializeMap();
            });
            
            // Timeout de securite
            setTimeout(function() {
                if (!mapLoaded && (!window.google || !window.google.maps)) {
                    console.log('Chargement manuel de Google Maps API...');
                    loadGoogleMapsAPIManually();
                }
            }, 3000);
        }
    });
    
    // Charger l'API Google Maps manuellement
    function loadGoogleMapsAPIManually() {
        if (typeof google !== 'undefined' && google.maps) {
            initializeMap();
            return;
        }
        
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places,geometry&callback=googleMapsAPIReady`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Echec du chargement de Google Maps API');
            showMapError();
        };
        document.head.appendChild(script);
    }
    
    // Fonction appelee par le callback de l'API
    function googleMapsAPIReady() {
        console.log('Google Maps API callback execute');
        initializeMap();
    }
    
    // Initialiser la carte
    function initializeMap() {
        try {
            console.log('Initialisation de la carte...');
            
            const mapElement = document.getElementById('booking-map');
            if (!mapElement) {
                console.error('Element carte non trouve');
                return;
            }
            
            map = new google.maps.Map(mapElement, {
                center: DEFAULT_CENTER,
                zoom: 13,
                mapTypeControl: false,
                fullscreenControl: true,
                streetViewControl: false,
                zoomControl: true,
                gestureHandling: 'greedy'
            });
            
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#f97316',
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            });
            
            map.addListener('click', handleMapClick);
            initAutocomplete();
            
            mapLoaded = true;
            hideMapLoading();
            
            console.log('Carte initialisee avec succes');
            
        } catch (error) {
            console.error('Erreur initialisation carte:', error);
            showMapError();
        }
    }
    
    function hideMapLoading() {
        const loadingEl = document.getElementById('map-loading');
        if (loadingEl) {
            loadingEl.style.opacity = '0';
            loadingEl.style.transition = 'opacity 0.3s ease';
            setTimeout(() => loadingEl.classList.add('hidden'), 300);
        }
    }
    
    function showMapError() {
        const loadingEl = document.getElementById('map-loading');
        const errorEl = document.getElementById('map-error');
        if (loadingEl) loadingEl.classList.add('hidden');
        if (errorEl) errorEl.classList.remove('hidden');
    }
    
    // Initialiser l'autocompletion des adresses
    function initAutocomplete() {
        if (typeof google === 'undefined' || !google.maps.places) {
            console.warn('Google Places non disponible');
            return;
        }
        
        const pickupInput = document.getElementById('id_pickup_address');
        const dropoffInput = document.getElementById('id_dropoff_address');
        
        // Autocompletion pour le depart
        pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, {
            types: ['address'],
            componentRestrictions: { country: 'cm' }
        });
        
        // Autocompletion pour la destination
        dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInput, {
            types: ['address'],
            componentRestrictions: { country: 'cm' }
        });
        
        // Evenement pour le depart
        pickupAutocomplete.addListener('place_changed', function() {
            const place = pickupAutocomplete.getPlace();
            if (place.geometry) {
                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();
                
                document.getElementById('id_pickup_lat').value = lat;
                document.getElementById('id_pickup_lng').value = lng;
                
                setPickup(lat, lng);
                showPickupStatus(true, 'Adresse selectionnee');
                
                if (!dropoffMarker) {
                    map.setCenter({ lat, lng });
                    map.setZoom(15);
                }
            }
        });
        
        // Evenement pour la destination
        dropoffAutocomplete.addListener('place_changed', function() {
            const place = dropoffAutocomplete.getPlace();
            if (place.geometry) {
                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();
                
                document.getElementById('id_dropoff_lat').value = lat;
                document.getElementById('id_dropoff_lng').value = lng;
                
                setDropoff(lat, lng);
                showDropoffStatus(true, 'Destination selectionnee');
                
                if (!pickupMarker) {
                    map.setCenter({ lat, lng });
                    map.setZoom(15);
                }
            }
        });
    }
    
    // Gerer le clic sur la carte
    function handleMapClick(e) {
        if (!map) return;
        
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();
        
        if (!pickupMarker) {
            setPickup(lat, lng);
            showPickupStatus(true, 'Position definie sur la carte');
        } else if (!dropoffMarker) {
            setDropoff(lat, lng);
            showDropoffStatus(true, 'Destination definie sur la carte');
            calculateRoute();
        } else {
            clearMarkers();
            setPickup(lat, lng);
            showPickupStatus(true, 'Position definie sur la carte');
        }
    }
    
    // Creer le marqueur de depart
    function setPickup(lat, lng, address) {
        if (pickupMarker) pickupMarker.setMap(null);
        
        pickupMarker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            icon: createMarkerIcon('green'),
            title: 'Point de depart',
            animation: google.maps.Animation.DROP,
            draggable: true
        });
        
        const addressText = address || document.getElementById('id_pickup_address').value || 'Point de depart';
        pickupMarker.infoWindow = new google.maps.InfoWindow({
            content: createInfoWindowContent('Point de depart', addressText, '#22c55e')
        });
        
        setTimeout(() => {
            if (pickupMarker) pickupMarker.infoWindow.open(map, pickupMarker);
        }, 300);
        
        pickupMarker.addListener('dragend', function() {
            const pos = pickupMarker.getPosition();
            document.getElementById('id_pickup_lat').value = pos.lat();
            document.getElementById('id_pickup_lng').value = pos.lng();
            if (dropoffMarker) calculateRoute();
        });
        
        document.getElementById('id_pickup_lat').value = lat;
        document.getElementById('id_pickup_lng').value = lng;
        
        if (dropoffMarker) calculateRoute();
        map.panTo({ lat, lng });
    }
    
    // Creer le marqueur de destination
    function setDropoff(lat, lng, address) {
        if (dropoffMarker) dropoffMarker.setMap(null);
        
        dropoffMarker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            icon: createMarkerIcon('red'),
            title: 'Destination',
            animation: google.maps.Animation.DROP,
            draggable: true
        });
        
        const addressText = address || document.getElementById('id_dropoff_address').value || 'Destination';
        dropoffMarker.infoWindow = new google.maps.InfoWindow({
            content: createInfoWindowContent('Destination', addressText, '#ef4444')
        });
        
        setTimeout(() => {
            if (dropoffMarker) dropoffMarker.infoWindow.open(map, dropoffMarker);
        }, 300);
        
        dropoffMarker.addListener('dragend', function() {
            const pos = dropoffMarker.getPosition();
            document.getElementById('id_dropoff_lat').value = pos.lat();
            document.getElementById('id_dropoff_lng').value = pos.lng();
            if (pickupMarker) calculateRoute();
        });
        
        document.getElementById('id_dropoff_lat').value = lat;
        document.getElementById('id_dropoff_lng').value = lng;
        
        calculateRoute();
        map.panTo({ lat, lng });
    }
    
    // Creer l'icone du marqueur
    function createMarkerIcon(color) {
        const colorHex = color === 'green' ? '#22c55e' : '#ef4444';
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 40" width="32" height="40">
            <path fill="${colorHex}" d="M12 0C5.4 0 0 5.4 0 12c0 9 12 28 12 28s12-19 12-28c0-6.6-5.4-12-12-12z"/>
            <circle fill="white" cx="12" cy="10" r="5"/>
        </svg>`;
        return {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
            scaledSize: new google.maps.Size(32, 40),
            anchor: new google.maps.Point(16, 40)
        };
    }
    
    // Creer le contenu de l'info window
    function createInfoWindowContent(title, address, color) {
        return `<div style="padding: 10px; min-width: 150px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <div style="width:12px;height:12px;background:${color};border-radius:50%;"></div>
                <strong>${title}</strong>
            </div>
            <p style="margin:0 0 0 20px;font-size:13px;color:#666;">${address}</p>
        </div>`;
    }
    
    // Calculer l'itineraire
    function calculateRoute() {
        if (!pickupMarker || !dropoffMarker || !directionsService) return;
        
        document.getElementById('estimated-distance').innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span>';
        document.getElementById('estimated-duration').innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span>';
        
        const request = {
            origin: pickupMarker.getPosition(),
            destination: dropoffMarker.getPosition(),
            travelMode: google.maps.TravelMode.DRIVING
        };
        
        directionsService.route(request, function(response, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                
                const leg = response.routes[0].legs[0];
                const distance = (leg.distance.value / 1000).toFixed(1);
                const duration = Math.round(leg.duration.value / 60);
                
                document.getElementById('estimated-distance').textContent = distance + ' km';
                document.getElementById('estimated-duration').textContent = duration + ' min';
                
                document.getElementById('route-info').classList.remove('hidden');
                document.getElementById('route-distance').textContent = distance + ' km';
                document.getElementById('route-duration').textContent = duration + ' min';
                
                calculateFare(distance, duration);
            } else {
                console.error('Echec calcul itineraire:', status);
                document.getElementById('estimated-distance').textContent = '-- km';
                document.getElementById('estimated-duration').textContent = '-- min';
            }
        });
    }
    
    // Calculer le prix
    function calculateFare(distance, duration) {
        const vehicleTypeInput = document.querySelector('input[name="vehicle_type"]:checked');
        const basePrice = vehicleTypeInput ? parseFloat(vehicleTypeInput.dataset.basePrice) || 500 : 500;
        const pricePerKm = vehicleTypeInput ? parseFloat(vehicleTypeInput.dataset.pricePerKm) || 300 : 300;
        
        const dist = distance || 0;
        const fare = basePrice + (pricePerKm * dist);
        
        const isShared = document.getElementById('is_shared').checked;
        const finalFare = isShared ? fare * 0.7 : fare;
        
        document.getElementById('estimated-fare').textContent = Math.round(finalFare).toLocaleString('fr-CM') + ' XAF';
    }
    
    // Utiliser la position actuelle
    function useCurrentLocation() {
        if (!navigator.geolocation) {
            alert('La geolocalisation n\'est pas supportee par votre navigateur.');
            return;
        }
        
        const btn = document.getElementById('location-btn-pickup');
        btn.style.opacity = '0.6';
        
        navigator.geolocation.getCurrentPosition(
            position => {
                const { latitude, longitude } = position.coords;
                map.setCenter({ lat: latitude, lng: longitude });
                map.setZoom(15);
                setPickup(latitude, longitude);
                showPickupStatus(true, 'Position actuelle');
                btn.style.opacity = '1';
            },
            error => {
                btn.style.opacity = '1';
                let errorMessage = 'Impossible d\'obtenir votre position.';
                if (error.code === error.PERMISSION_DENIED) {
                    errorMessage = 'Permission refusee. Veuillez autoriser l\'acces a votre position.';
                }
                showPickupStatus(false, errorMessage);
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }
    
    // Echanger les positions
    function swapLocations() {
        if (!pickupMarker || !dropoffMarker) return;
        
        const pickupLat = document.getElementById('id_pickup_lat').value;
        const pickupLng = document.getElementById('id_pickup_lng').value;
        const pickupAddr = document.getElementById('id_pickup_address').value;
        
        const dropoffLat = document.getElementById('id_dropoff_lat').value;
        const dropoffLng = document.getElementById('id_dropoff_lng').value;
        const dropoffAddr = document.getElementById('id_dropoff_address').value;
        
        document.getElementById('id_pickup_lat').value = dropoffLat;
        document.getElementById('id_pickup_lng').value = dropoffLng;
        document.getElementById('id_pickup_address').value = dropoffAddr;
        
        document.getElementById('id_dropoff_lat').value = pickupLat;
        document.getElementById('id_dropoff_lng').value = pickupLng;
        document.getElementById('id_dropoff_address').value = pickupAddr;
        
        const pickupPos = pickupMarker.getPosition();
        const dropoffPos = dropoffMarker.getPosition();
        
        setPickup(dropoffPos.lat(), dropoffPos.lng(), dropoffAddr);
        setDropoff(pickupPos.lat(), pickupPos.lng(), pickupAddr);
        
        showPickupStatus(true, 'Points echanges');
    }
    
    // Effacer les positions
    function clearLocations() {
        document.getElementById('id_pickup_address').value = '';
        document.getElementById('id_pickup_lat').value = '';
        document.getElementById('id_pickup_lng').value = '';
        
        document.getElementById('id_dropoff_address').value = '';
        document.getElementById('id_dropoff_lat').value = '';
        document.getElementById('id_dropoff_lng').value = '';
        
        clearMarkers();
        
        document.getElementById('pickup-status').classList.add('hidden');
        document.getElementById('dropoff-status').classList.add('hidden');
        document.getElementById('route-info').classList.add('hidden');
    }
    
    // Effacer les marqueurs
    function clearMarkers() {
        if (pickupMarker) {
            pickupMarker.setMap(null);
            pickupMarker = null;
        }
        if (dropoffMarker) {
            dropoffMarker.setMap(null);
            dropoffMarker = null;
        }
        if (directionsRenderer) {
            directionsRenderer.setDirections({ routes: [] });
        }
        
        document.getElementById('estimated-distance').textContent = '-- km';
        document.getElementById('estimated-duration').textContent = '-- min';
        document.getElementById('estimated-fare').textContent = '-- XAF';
    }
    
    // Recentrer sur le depart
    function focusOnPickup() {
        if (pickupMarker) {
            map.setCenter(pickupMarker.getPosition());
            map.setZoom(16);
            pickupMarker.infoWindow.open(map, pickupMarker);
        }
    }
    
    // Recentrer sur la destination
    function focusOnDropoff() {
        if (dropoffMarker) {
            map.setCenter(dropoffMarker.getPosition());
            map.setZoom(16);
            dropoffMarker.infoWindow.open(map, dropoffMarker);
        }
    }
    
    // Afficher le statut du depart
    function showPickupStatus(success, message) {
        const statusEl = document.getElementById('pickup-status');
        const textEl = document.getElementById('pickup-status-text');
        
        statusEl.classList.remove('hidden');
        textEl.innerHTML = `<i class="fas ${success ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-1"></i>${message}`;
        textEl.style.color = success ? '#16a34a' : '#dc2626';
        
        if (success) {
            setTimeout(() => statusEl.classList.add('hidden'), 3000);
        }
    }
    
    // Afficher le statut de la destination
    function showDropoffStatus(success, message) {
        const statusEl = document.getElementById('dropoff-status');
        const textEl = document.getElementById('dropoff-status-text');
        
        statusEl.classList.remove('hidden');
        textEl.innerHTML = `<i class="fas ${success ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-1"></i>${message}`;
        textEl.style.color = success ? '#16a34a' : '#dc2626';
        
        if (success) {
            setTimeout(() => statusEl.classList.add('hidden'), 3000);
        }
    }
    
    // Event listener pour le covoiturage - recalculer le prix quand la case est cochée/décochée
    document.getElementById('is_shared').addEventListener('change', function() {
        const pickupLat = document.getElementById('id_pickup_lat').value;
        const dropoffLat = document.getElementById('id_dropoff_lat').value;
        
        // Only recalculate if both locations are set
        if (pickupLat && dropoffLat) {
            // Get current distance and duration from the display
            const distanceText = document.getElementById('estimated-distance').textContent;
            const durationText = document.getElementById('estimated-duration').textContent;
            
            if (distanceText && durationText && 
                distanceText !== '-- km' && durationText !== '-- min') {
                const distance = parseFloat(distanceText.replace(' km', ''));
                const duration = parseInt(durationText.replace(' min', ''));
                calculateFare(distance, duration);
            }
        }
        
        // Update the label text to show current state
        const label = document.querySelector('label[for="is_shared"]');
        if (this.checked) {
            label.innerHTML = '<i class="fas fa-users text-orange-500 mr-1"></i><strong>Covoiturage</strong> <span class="text-green-600">(-30%)</span>';
        } else {
            label.innerHTML = '<i class="fas fa-users text-orange-500 mr-1"></i><strong>Covoiturage</strong> (-30%)';
        }
    });
    
    // ===========================================
    // Driver Search and Selection Functions
    // ===========================================
    
    // Selected driver data
    let selectedDriver = null;
    let driverMarkers = [];
    let availableDrivers = [];
    
    // Validate form and search drivers
    function validateAndSearchDrivers() {
        const pickupLat = document.getElementById('id_pickup_lat').value;
        const dropoffLat = document.getElementById('id_dropoff_lat').value;
        
        if (!pickupLat || !dropoffLat) {
            alert('Veuillez selectionner un point de depart et une destination.');
            return;
        }
        
        searchAvailableDrivers();
    }
    
    // Search for available drivers
    async function searchAvailableDrivers() {
        const pickupLat = document.getElementById('id_pickup_lat').value;
        const pickupLng = document.getElementById('id_pickup_lng').value;
        const dropoffLat = document.getElementById('id_dropoff_lat').value;
        const dropoffLng = document.getElementById('id_dropoff_lng').value;
        
        // Get selected vehicle type
        const vehicleTypeInput = document.querySelector('input[name="vehicle_type"]:checked');
        const vehicleTypeId = vehicleTypeInput ? vehicleTypeInput.value : '';
        
        if (!pickupLat || !pickupLng || !dropoffLat || !dropoffLng) {
            alert('Veuillez selectionner un point de depart et une destination.');
            return;
        }
        
        // Show loading state
        document.getElementById('drivers-loading').classList.remove('hidden');
        document.getElementById('drivers-list').classList.add('hidden');
        document.getElementById('no-drivers').classList.add('hidden');
        document.getElementById('driver-selection-section').classList.remove('hidden');
        document.getElementById('initial-submit-btn').classList.add('hidden');
        
        // Calculate center point for search
        const centerLat = (parseFloat(pickupLat) + parseFloat(dropoffLat)) / 2;
        const centerLng = (parseFloat(pickupLng) + parseFloat(dropoffLng)) / 2;
        
        try {
            const response = await fetch(`/api/booking/drivers/search/?lat=${centerLat}&lng=${centerLng}&vehicle_type=${vehicleTypeId}&radius=10000`, {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            document.getElementById('drivers-loading').classList.add('hidden');
            
            if (data.drivers && data.drivers.length > 0) {
                availableDrivers = data.drivers;
                displayDriversOnMap(data.drivers);
                displayDriversList(data.drivers);
                document.getElementById('drivers-list').classList.remove('hidden');
            } else {
                // Afficher le message d'avertissement de l'API
                const noDriversEl = document.getElementById('no-drivers');
                noDriversEl.classList.remove('hidden');
                
                if (data.warning) {
                    // Remplacer le message par défaut par le message de l'API
                    const messageEl = noDriversEl.querySelector('p.text-gray-500');
                    const hintEl = noDriversEl.querySelector('p.text-sm.text-gray-400');
                    if (messageEl) messageEl.textContent = data.warning;
                    if (hintEl) hintEl.style.display = 'none';
                }
                
                // Afficher les infos de debug en console pour le développement
                if (data.debug_info) {
                    console.log('Debug info - Chauffeurs:', data.debug_info);
                }
            }
            
        } catch (error) {
            console.error('Erreur lors de la recherche de chauffeurs:', error);
            document.getElementById('drivers-loading').classList.add('hidden');
            document.getElementById('no-drivers').classList.remove('hidden');
        }
    }
    
    // Display drivers on map
    function displayDriversOnMap(drivers) {
        // Clear existing driver markers
        driverMarkers.forEach(marker => marker.setMap(null));
        driverMarkers = [];
        
        drivers.forEach(driver => {
            if (driver.lat && driver.lng) {
                const marker = new google.maps.Marker({
                    position: { lat: driver.lat, lng: driver.lng },
                    map: map,
                    icon: createDriverMarkerIcon(driver.vehicle_type),
                    title: driver.name,
                    animation: google.maps.Animation.DROP
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; min-width: 150px;">
                            <strong>${driver.name}</strong><br>
                            <span style="color: #666;">${driver.vehicle_type}</span><br>
                            <span style="color: #f97316;">★ ${driver.rating || 'Nouveau'}</span><br>
                            <span style="color: #16a34a;">${driver.distance ? driver.distance.toFixed(1) + ' km' : ''}</span>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                driverMarkers.push(marker);
            }
        });
        
        // Fit map to show all drivers
        if (driverMarkers.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            driverMarkers.forEach(marker => bounds.extend(marker.getPosition()));
            // Also include pickup and dropoff
            if (pickupMarker) bounds.extend(pickupMarker.getPosition());
            if (dropoffMarker) bounds.extend(dropoffMarker.getPosition());
            map.fitBounds(bounds);
        }
    }
    
    // Create driver marker icon based on vehicle type
    function createDriverMarkerIcon(vehicleType) {
        let color = '#f97316'; // orange default
        let icon = 'fa-car';
        
        if (vehicleType === 'moto') {
            color = '#3b82f6'; // blue
            icon = 'fa-motorcycle';
        } else if (vehicleType === 'van') {
            color = '#8b5cf6'; // purple
            icon = 'fa-shuttle-van';
        } else if (vehicleType === 'vip') {
            color = '#eab308'; // gold
            icon = 'fa-star';
        }
        
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 40" width="32" height="40">
            <path fill="${color}" d="M12 0C5.4 0 0 5.4 0 12c0 9 12 28 12 28s12-19 12-28c0-6.6-5.4-12-12-12z"/>
            <circle fill="white" cx="12" cy="10" r="5"/>
        </svg>`;
        
        return {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
            scaledSize: new google.maps.Size(32, 40),
            anchor: new google.maps.Point(16, 40)
        };
    }
    
    // Display drivers list
    function displayDriversList(drivers) {
        const listContainer = document.getElementById('drivers-list');
        listContainer.innerHTML = '';
        
        drivers.forEach(driver => {
            const driverCard = document.createElement('div');
            driverCard.className = 'driver-card p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition';
            driverCard.onclick = () => selectDriver(driver);
            
            const vehicleIcon = getVehicleIcon(driver.vehicle_type);
            
            driverCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                            <i class="fas ${vehicleIcon} text-gray-500"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${driver.name}</p>
                            <p class="text-xs text-gray-500">${driver.vehicle_type}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-orange-500">${driver.distance ? driver.distance.toFixed(1) + ' km' : ''}</p>
                        <p class="text-xs text-gray-500">${driver.rating ? '★ ' + driver.rating.toFixed(1) : 'Nouveau'}</p>
                    </div>
                </div>
            `;
            
            listContainer.appendChild(driverCard);
        });
    }
    
    // Get vehicle icon
    function getVehicleIcon(vehicleType) {
        switch(vehicleType) {
            case 'moto': return 'fa-motorcycle';
            case 'van': return 'fa-shuttle-van';
            case 'vip': return 'fa-star';
            default: return 'fa-car';
        }
    }
    
    // Select a driver
    function selectDriver(driver) {
        selectedDriver = driver;
        
        // Update UI to show selected driver
        document.getElementById('selected-driver-display').classList.remove('hidden');
        document.getElementById('selected-driver-name').textContent = driver.name;
        
        // Highlight selected driver in list
        const cards = document.querySelectorAll('.driver-card');
        cards.forEach(card => {
            card.classList.remove('border-orange-500', 'bg-orange-50');
            card.classList.add('border-gray-200');
        });
        
        // Show payment section
        document.getElementById('payment-section').classList.remove('hidden');
        
        // Add hidden input for driver selection
        const form = document.getElementById('booking-form');
        let driverInput = document.getElementById('selected-driver-id');
        if (!driverInput) {
            driverInput = document.createElement('input');
            driverInput.type = 'hidden';
            driverInput.id = 'selected-driver-id';
            driverInput.name = 'selected_driver_id';
            form.appendChild(driverInput);
        }
        driverInput.value = driver.id;
        
        // Scroll to payment section
        document.getElementById('payment-section').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Clear driver selection
    function clearDriverSelection() {
        selectedDriver = null;
        
        // Hide selected driver display
        document.getElementById('selected-driver-display').classList.add('hidden');
        
        // Reset driver list highlighting
        const cards = document.querySelectorAll('.driver-card');
        cards.forEach(card => {
            card.classList.remove('border-orange-500', 'bg-orange-50');
            card.classList.add('border-gray-200');
        });
        
        // Hide payment section
        document.getElementById('payment-section').classList.add('hidden');
        
        // Remove hidden input
        const driverInput = document.getElementById('selected-driver-id');
        if (driverInput) {
            driverInput.remove();
        }
    }
    
    // Form submission handler
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        if (!selectedDriver) {
            e.preventDefault();
            alert('Veuillez selectionner un chauffeur.');
            return;
        }
        
        const paymentMethod = document.getElementById('payment-method-select').value;
        // Store payment method in a hidden input if needed
        console.log('Booking with driver:', selectedDriver.name, 'Payment method:', paymentMethod);
    });
    
    // Get cookie helper function (for CSRF)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // ===========================================
    // Payment Modal Functions
    // ===========================================
    
    // Open payment modal
    function openPaymentModal() {
        if (!selectedDriver) {
            alert('Veuillez sélectionner un chauffeur.');
            return;
        }
        
        // Get current trip details
        const distance = document.getElementById('estimated-distance').textContent;
        const duration = document.getElementById('estimated-duration').textContent;
        const fare = document.getElementById('estimated-fare').textContent;
        
        // Update modal content
        document.getElementById('modal-driver-name').textContent = selectedDriver.name;
        document.getElementById('modal-distance').textContent = distance || '-- km';
        document.getElementById('modal-duration').textContent = duration || '-- min';
        document.getElementById('modal-fare').textContent = fare || '-- XAF';
        
        // Reset modal state
        document.getElementById('payment-loading').classList.add('hidden');
        document.getElementById('payment-error').classList.add('hidden');
        document.getElementById('payment-success').classList.add('hidden');
        document.getElementById('modal-payment-details').classList.add('hidden');
        document.getElementById('modal-footer').classList.remove('hidden');
        
        // Show modal
        document.getElementById('payment-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    // Close payment modal
    function closePaymentModal() {
        document.getElementById('payment-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    // Handle payment method change in modal
    document.querySelectorAll('input[name="modal_payment_method"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const detailsSection = document.getElementById('modal-payment-details');
            const cardDetails = document.getElementById('card-details');
            const mobileDetails = document.getElementById('mobile-details');
            
            if (this.value === 'card') {
                detailsSection.classList.remove('hidden');
                cardDetails.classList.remove('hidden');
                mobileDetails.classList.add('hidden');
            } else if (this.value === 'mobile_money' || this.value === 'orange_money') {
                detailsSection.classList.remove('hidden');
                cardDetails.classList.add('hidden');
                mobileDetails.classList.remove('hidden');
            } else {
                detailsSection.classList.add('hidden');
            }
        });
    });
    
    // Process payment
    async function processPayment() {
        if (!selectedDriver) {
            alert('Veuillez sélectionner un chauffeur.');
            return;
        }
        
        // Get payment method
        const paymentMethod = document.querySelector('input[name="modal_payment_method"]:checked').value;
        
        // Show loading
        document.getElementById('payment-loading').classList.remove('hidden');
        document.getElementById('modal-footer').classList.add('hidden');
        document.getElementById('payment-error').classList.add('hidden');
        
        // Get booking details from form
        const pickupLat = document.getElementById('id_pickup_lat').value;
        const pickupLng = document.getElementById('id_pickup_lng').value;
        const dropoffLat = document.getElementById('id_dropoff_lat').value;
        const dropoffLng = document.getElementById('id_dropoff_lng').value;
        const pickupAddress = document.getElementById('id_pickup_address').value;
        const dropoffAddress = document.getElementById('id_dropoff_address').value;
        const vehicleTypeInput = document.querySelector('input[name="vehicle_type"]:checked');
        const vehicleTypeId = vehicleTypeInput ? vehicleTypeInput.value : '';
        
        // Get distance and fare
        const distanceText = document.getElementById('estimated-distance').textContent;
        const durationText = document.getElementById('estimated-duration').textContent;
        const fareText = document.getElementById('estimated-fare').textContent;
        
        const distance = parseFloat(distanceText.replace(' km', '').replace(',', '.')) || 0;
        const duration = parseInt(durationText.replace(' min', '')) || 0;
        const fare = parseFloat(fareText.replace(' XAF', '').replace(/\s/g, '').replace(',', '.')) || 0;
        
        const isShared = document.getElementById('is_shared').checked;
        
        try {
            // Simulate payment processing delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Call API to create booking and confirm payment
            const response = await fetch('/api/booking/confirm-payment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    driver_id: selectedDriver.id,
                    pickup_lat: pickupLat,
                    pickup_lng: pickupLng,
                    dropoff_lat: dropoffLat,
                    dropoff_lng: dropoffLng,
                    pickup_address: pickupAddress,
                    dropoff_address: dropoffAddress,
                    vehicle_type_id: vehicleTypeId,
                    distance: distance,
                    duration: duration,
                    fare: fare,
                    is_shared: isShared,
                    payment_method: paymentMethod
                })
            });
            
            const data = await response.json();
            
            document.getElementById('payment-loading').classList.add('hidden');
            
            if (data.success) {
                // Show success
                document.getElementById('payment-success').classList.remove('hidden');
                
                // Wait a moment then redirect
                setTimeout(() => {
                    if (data.trip_url) {
                        window.location.href = data.trip_url;
                    } else {
                        // Fallback redirect
                        window.location.href = '/booking/trip/' + data.trip_id + '/';
                    }
                }, 1500);
                
            } else {
                // Show error
                document.getElementById('payment-error').classList.remove('hidden');
                document.getElementById('payment-error-text').textContent = data.error || 'Erreur lors du paiement';
                document.getElementById('modal-footer').classList.remove('hidden');
            }
            
        } catch (error) {
            console.error('Erreur paiement:', error);
            document.getElementById('payment-loading').classList.add('hidden');
            document.getElementById('payment-error').classList.remove('hidden');
            document.getElementById('payment-error-text').textContent = 'Erreur de connexion. Veuillez réessayer.';
            document.getElementById('modal-footer').classList.remove('hidden');
        }
    }
    
    // Update the form submission handler to use modal instead
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        // Prevent default form submission
        e.preventDefault();
        
        if (!selectedDriver) {
            alert('Veuillez sélectionner un chauffeur.');
            return;
        }
        
        // Open payment modal instead of direct submission
        openPaymentModal();
    });
</script>
{% endblock %}

